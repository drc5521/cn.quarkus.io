<!DOCTYPE html>
<html>





<head>
  <title>Quarkus - 简化的Hibernate 响应式与Panache - 2.7</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src https://dpm.demdex.net; script-src 'self' 'unsafe-eval' 'sha256-ANpuoVzuSex6VhqpYgsG25OHWVA1I+F6aGU04LoI+5s=' 'sha256-ipy9P/3rZZW06mTLAR0EnXvxSNcnfSDPLDuh3kzbB1w=' js.bizographics.com https://www.redhat.com https://static.redhat.com assets.adobedtm.com jsonip.com https://ajax.googleapis.com https://www.googletagmanager.com https://www.google-analytics.com https://use.fontawesome.com https://app.mailjet.com http://www.youtube.com http://www.googleadservices.com https://googleads.g.doubleclick.net https://dpm.demdex.net https://giscus.app; style-src 'self' https://fonts.googleapis.com https://use.fontawesome.com; img-src 'self' *; media-src 'self'; frame-src https://www.googletagmanager.com https://www.youtube.com https://embed.restream.io https://app.mailjet.com https://giscus.app; base-uri 'none'; object-src 'none'; form-action 'none'; font-src 'self' https://use.fontawesome.com https://fonts.gstatic.com;" />
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/2.7/guides/hibernate-reactive-panache" />
  <meta property="og:title" content="简化的Hibernate 响应式与Panache - 2.7" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/hibernate-reactive-panache">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  

<div class="grid-wrapper communitysite">
  <div class="grid__item width-12-12">The <a href="https://quarkus.io">English version of quarkus.io</a> is the official project site. Translated sites are community supported on a best-effort basis.</div>
</div>


  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
    </div>
    <label class="nav-toggle" for="checkbox"> <i class="fa fa-bars"></i>
</label>
    <ul id="menu" class="menu">
      <li class="dropdown">
        <span href="/about/">关于<i class="fas fa-chevron-down">
</i></span>
        <ul class="submenu">
          <li><a href="/about" class="">QUARKUS是什么？</a></li>
          <li><a href="/container-first" class="">容器优先 </a></li>
          <li><a href="/continuum" class="">响应式</a></li>
          <li><a href="/developer-joy" class="">开发者的乐趣 </a></li>
          <li><a href="/kubernetes-native" class="">KUBERNETES 原生</a></li>
          <li><a href="/standards" class="">标准</a></li>
        </ul>
      </li>
      <li class="dropdown">
        <span href="/learn/">学习 <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/get-started" class="">入门</a></li>
          <li><a href="/guides" class="active" >指南</a></li>
          <li><a href="/qtips" class="">"Q" TIP视频</a></li>          
          <li><a href="/books" class="">书籍</a></li>
          </ul>
      </li>
      <li class="dropdown">
        <span href="/community/">社区 <i class="fas
fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="/support/" class="">支持</a></li>
          <li><a href="/blog" class="" >博客</a></li>
          <li><a href="/discussion" class="">讨论</a></li>
          <li><a href="/insights" class="" >播客</a></li>
          <li><a href="/events" class="">活动</a></li>
          <li><a href="/newsletter" class="">新闻</a></li>
          <li><a href="/publications" class="">发表</a></li>
          <li><a href="/awards" class="">获奖</a></li>
          </ul>
      </li>
      <li>
        <a href="https://code.quarkus.io" class="button-cta secondary
white">开始写代码</a>
      </li>
      <li class="dropdown">
        <span href="/language/"><div class="fas fa-globe langicon"></div><i class="fas fa-chevron-down"></i></span>
        <ul class="submenu">
          <li><a href="https://quarkus.io/" >OFFICIAL (ENGLISH)</a></li>
          <li><a href="https://ja.quarkus.io/">日本語 - JAPANESE</a></li>
          <li><a href="https://cn.quarkus.io/">简体中文 - CHINESE</a></li>
          </ul>
      </li>
    </ul>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    



<div class="full-width-version-bg grey align-self">
  <div class="grid-wrapper">
    <div class="grid__item width-6-12">
      <p class="returnlink"><i class="fas fa-angle-left"></i><a href="/version/2.7/guides/">返回指南目录</a></p>
    </div>
    <div class="grid__item width-6-12 align-self-center text-right hide-mobile">
      <label id="guide-version-label">选择指南版本</label>
      <select id="guide-version-dropdown">
        
      
        
        
        
        
          
        <option value="main" >Main - SNAPSHOT</option>
        
        
      
        
        
        
        
          
        <option value="latest" >2.9 - Latest</option>
        
        
      
        
        
        
        
          
        <option value="2.7" selected>2.7</option>
        
        
      
        
        
        
        
          
        <option value="2.2" >2.2</option>
        
        
      
        
        
        
        
      
    
      </select>
    </div>
  </div>
</div>

<div class="grid-wrapper guide">
  <div class="grid__item width-12-12 width-12-12-mobile">
    <h1 class="text-caps">简化的Hibernate 响应式与Panache </h1>
  </div>
  <div class="width-12-12">
    <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#第一一个例子">第一：一个例子</a></li>
<li><a href="#解决方案">解决方案</a></li>
<li><a href="#setting-up-and-configuring-hibernate-reactive-with-panache">Setting up and configuring Hibernate Reactive with Panache</a></li>
<li><a href="#解决方案1使用active-record活动记录模式">解决方案1：使用active record（活动记录）模式</a>
<ul class="sectlevel2">
<li><a href="#定义你的实体">定义你的实体</a></li>
<li><a href="#最有用的操作">最有用的操作</a></li>
<li><a href="#添加实体方法">添加实体方法</a></li>
</ul>
</li>
<li><a href="#解决方案2使用资源库模式">解决方案2：使用资源库模式</a>
<ul class="sectlevel2">
<li><a href="#定义你的实体-2">定义你的实体</a></li>
<li><a href="#定义你的存储库">定义你的存储库</a></li>
<li><a href="#最有用的操作-2">最有用的操作</a></li>
</ul>
</li>
<li><a href="#高级查询">高级查询</a>
<ul class="sectlevel2">
<li><a href="#分页">分页</a></li>
<li><a href="#使用range而不是pages">使用range而不是pages</a></li>
<li><a href="#排序">排序</a></li>
<li><a href="#简化查询">简化查询</a></li>
<li><a href="#named-queries">Named queries</a></li>
<li><a href="#查询参数">查询参数</a></li>
<li><a href="#查询映射">查询映射</a></li>
</ul>
</li>
<li><a href="#multiple-persistence-units">Multiple Persistence Units</a></li>
<li><a href="#事务">事务</a></li>
<li><a href="#lock-management">Lock management</a>
<ul class="sectlevel2">
<li><a href="#first-locking-using-findbyid">First: Locking using findById().</a></li>
<li><a href="#second-locking-in-a-find">Second: Locking in a find().</a></li>
</ul>
</li>
<li><a href="#自定义id">自定义ID</a></li>
<li><a href="#mocking">Mocking</a>
<ul class="sectlevel2">
<li><a href="#using-the-active-record-pattern">Using the active record pattern</a></li>
<li><a href="#使用资源库模式">使用资源库模式</a></li>
</ul>
</li>
<li><a href="#how-and-why-we-simplify-hibernate-reactive-mappings">How and why we simplify Hibernate Reactive mappings</a></li>
<li><a href="#在外部项目或jar中定义实体">在外部项目或jar中定义实体</a></li>
</ul></div>
    <div>
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://hibernate.org/reactive/">Hibernate Reactive</a> is the only reactive JPA implementation and offers you the full breadth of an Object Relational Mapper allowing you to access your database over reactive drivers. It makes complex mappings possible, but it does not make simple and common mappings trivial. Hibernate Reactive with Panache focuses on making your entities trivial and fun to write in Quarkus.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="第一一个例子"><a class="anchor" href="#第一一个例子"></a>第一：一个例子</h2>
<div class="sectionbody">
<div class="paragraph">
<p>What we&#8217;re doing in Panache is allow you to write your Hibernate Reactive entities like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person extends PanacheEntity {
    public String name;
    public LocalDate birth;
    public Status status;

    public static Uni&lt;Person&gt; findByName(String name){
        return find("name", name).firstResult();
    }

    public static Uni&lt;List&lt;Person&gt;&gt; findAlive(){
        return list("status", Status.Alive);
    }

    public static Uni&lt;Long&gt; deleteStefs(){
        return delete("name", "Stef");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You have noticed how much more compact and readable the code is? Does this look interesting? Read on!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
the <code>list()</code> method might be surprising at first. It takes fragments of HQL (JP-QL) queries and contextualizes the rest. That makes for very concise but yet readable code.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
what was described above is essentially the <a href="https://www.martinfowler.com/eaaCatalog/activeRecord.html">active record pattern</a>, sometimes just called the entity pattern. Hibernate with Panache also allows for the use of the more classical <a href="https://martinfowler.com/eaaCatalog/repository.html">repository pattern</a> via <code>PanacheRepository</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="解决方案"><a class="anchor" href="#解决方案"></a>解决方案</h2>
<div class="sectionbody">
<div class="paragraph">
<p>我们建议您按照下一节的说明逐步创建应用程序。然而，您可以直接转到已完成的示例。</p>
</div>
<div class="paragraph">
<p>克隆 Git 仓库: <code>git clone <a href="https://github.com/quarkusio/quarkus-quickstarts.git" class="bare">https://github.com/quarkusio/quarkus-quickstarts.git</a></code> ，或下载一个 <a href="https://github.com/quarkusio/quarkus-quickstarts/archive/main.zip">存档</a> 。</p>
</div>
<div class="paragraph">
<p>The solution is located in the <code>hibernate-reactive-panache-quickstart</code> <a href="https://github.com/quarkusio/quarkus-quickstarts/tree/main/hibernate-reactive-panache-quickstart">directory</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="setting-up-and-configuring-hibernate-reactive-with-panache"><a class="anchor" href="#setting-up-and-configuring-hibernate-reactive-with-panache"></a>Setting up and configuring Hibernate Reactive with Panache</h2>
<div class="sectionbody">
<div class="paragraph">
<p>起步：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>add your settings in <code>application.properties</code></p>
</li>
<li>
<p>annotate your entities with <code>@Entity</code></p>
</li>
<li>
<p>make your entities extend <code>PanacheEntity</code> (optional if you are using the repository pattern)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Follow the <a href="hibernate-orm#setting-up-and-configuring-hibernate-orm">Hibernate set-up guide for all configuration</a>.</p>
</div>
<div class="paragraph">
<p>In your <code>pom.xml</code>, add the following dependencies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the Hibernate Reactive with Panache extension</p>
</li>
<li>
<p>your reactive driver extension (<code>quarkus-reactive-pg-client</code>, <code>quarkus-reactive-mysql-client</code>, <code>quarkus-reactive-db2-client</code>, &#8230;&#8203;)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For instance:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;!-- Hibernate Reactive dependency --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-hibernate-reactive-panache&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- Reactive SQL client for PostgreSQL --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-reactive-pg-client&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">// Hibernate Reactive dependency
implementation("io.quarkus:quarkus-hibernate-reactive-panache")

Reactive SQL client for PostgreSQL
implementation("io.quarkus:quarkus-reactive-pg-client")</code></pre>
</div>
</div>
<div class="paragraph">
<p>然后在 <code>application.properties</code> 中添加相关的配置属性。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># configure your datasource
quarkus.datasource.db-kind = postgresql
quarkus.datasource.username = sarah
quarkus.datasource.password = connor
quarkus.datasource.reactive.url = vertx-reactive:postgresql://localhost:5432/mydatabase

# drop and create the database at startup (use `update` to only update the schema)
quarkus.hibernate-orm.database.generation = drop-and-create</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="解决方案1使用active-record活动记录模式"><a class="anchor" href="#解决方案1使用active-record活动记录模式"></a>解决方案1：使用active record（活动记录）模式</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="定义你的实体"><a class="anchor" href="#定义你的实体"></a>定义你的实体</h3>
<div class="paragraph">
<p>To define a Panache entity, simply extend <code>PanacheEntity</code>, annotate it with <code>@Entity</code> and add your columns as public fields:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person extends PanacheEntity {
    public String name;
    public LocalDate birth;
    public Status status;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can put all your JPA column annotations on the public fields. If you need a field to not be persisted, use the <code>@Transient</code> annotation on it. If you need to write accessors, you can:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person extends PanacheEntity {
    public String name;
    public LocalDate birth;
    public Status status;

    // return name as uppercase in the model
    public String getName(){
        return name.toUpperCase();
    }

    // store all names in lowercase in the DB
    public void setName(String name){
        this.name = name.toLowerCase();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>而且由于我们的字段访问重写，当你的用户读取 <code>person.name</code> ，他们实际上会调用你的 <code>getName()</code> 方法，类似的还有字段写入和设置器。这允许在运行时进行适当的封装，因为所有字段的调用都将被相应的getter/setter调用所取代。</p>
</div>
</div>
<div class="sect2">
<h3 id="最有用的操作"><a class="anchor" href="#最有用的操作"></a>最有用的操作</h3>
<div class="paragraph">
<p>编写实体后，可以执行以下最常见的操作：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// creating a person
Person person = new Person();
person.name = "Stef";
person.birth = LocalDate.of(1910, Month.FEBRUARY, 1);
person.status = Status.Alive;

// persist it
Uni&lt;Void&gt; persistOperation = person.persist();

// note that once persisted, you don't need to explicitly save your entity: all
// modifications are automatically persisted on transaction commit.

// check if it's persistent
if(person.isPersistent()){
    // delete it
    Uni&lt;Void&gt; deleteOperation = person.delete();
}

// getting a list of all Person entities
Uni&lt;List&lt;Person&gt;&gt; allPersons = Person.listAll();

// finding a specific person by ID
Uni&lt;Person&gt; personById = Person.findById(23L);

// finding all living persons
Uni&lt;List&lt;Person&gt;&gt; livingPersons = Person.list("status", Status.Alive);

// counting all persons
Uni&lt;Long&gt; countAll = Person.count();

// counting all living persons
Uni&lt;Long&gt; countAlive = Person.count("status", Status.Alive);

// delete all living persons
Uni&lt;Long&gt; deleteAliveOperation = Person.delete("status", Status.Alive);

// delete all persons
Uni&lt;Long&gt; deleteAllOperation = Person.deleteAll();

// delete by id
Uni&lt;Boolean&gt; deleteByIdOperation = Person.deleteById(23L);

// set the name of all living persons to 'Mortal'
Uni&lt;Integer&gt; updateOperation = Person.update("name = 'Mortal' where status = ?1", Status.Alive);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="添加实体方法"><a class="anchor" href="#添加实体方法"></a>添加实体方法</h3>
<div class="paragraph">
<p>在实体本身内部的实体上添加自定义查询。这样，您和您的同事可以轻松找到它们，并且查询与他们操作的对象位于同一位置。将它们作为静态方法添加到实体类中是 Panache Active Record 方式。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person extends PanacheEntity {
    public String name;
    public LocalDate birth;
    public Status status;

    public static Uni&lt;Person&gt; findByName(String name){
        return find("name", name).firstResult();
    }

    public static Uni&lt;List&lt;Person&gt;&gt; findAlive(){
        return list("status", Status.Alive);
    }

    public static Uni&lt;Long&gt; deleteStefs(){
        return delete("name", "Stef");
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="解决方案2使用资源库模式"><a class="anchor" href="#解决方案2使用资源库模式"></a>解决方案2：使用资源库模式</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="定义你的实体-2"><a class="anchor" href="#定义你的实体-2"></a>定义你的实体</h3>
<div class="paragraph">
<p>When using the repository pattern, you can define your entities as regular JPA entities.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person {
    @Id @GeneratedValue private Long id;
    private String name;
    private LocalDate birth;
    private Status status;

    public Long getId(){
        return id;
    }
    public void setId(Long id){
        this.id = id;
    }
    public String getName() {
        return name;
    }
    public void setName(String name) {
        this.name = name;
    }
    public LocalDate getBirth() {
        return birth;
    }
    public void setBirth(LocalDate birth) {
        this.birth = birth;
    }
    public Status getStatus() {
        return status;
    }
    public void setStatus(Status status) {
        this.status = status;
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you don&#8217;t want to bother defining getters/setters for your entities, you can make them extend <code>PanacheEntityBase</code> and Quarkus will generate them for you. You can even extend <code>PanacheEntity</code> and take advantage of the default ID it provides.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="定义你的存储库"><a class="anchor" href="#定义你的存储库"></a>定义你的存储库</h3>
<div class="paragraph">
<p>When using Repositories, you get the exact same convenient methods as with the active record pattern, injected in your Repository, by making them implements <code>PanacheRepository</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class PersonRepository implements PanacheRepository&lt;Person&gt; {

   // put your custom logic here as instance methods

   public Uni&lt;Person&gt; findByName(String name){
       return find("name", name).firstResult();
   }

   public Uni&lt;List&lt;Person&gt;&gt; findAlive(){
       return list("status", Status.Alive);
   }

   public Uni&lt;Long&gt; deleteStefs(){
       return delete("name", "Stef");
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the operations that are defined on <code>PanacheEntityBase</code> are available on your repository, so using it is exactly the same as using the active record pattern, except you need to inject it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject
PersonRepository personRepository;

@GET
public Uni&lt;Long&gt; count(){
    return personRepository.count();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="最有用的操作-2"><a class="anchor" href="#最有用的操作-2"></a>最有用的操作</h3>
<div class="paragraph">
<p>编写存储库后，您可以执行以下最常见的操作：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// creating a person
Person person = new Person();
person.setName("Stef");
person.setBirth(LocalDate.of(1910, Month.FEBRUARY, 1));
person.setStatus(Status.Alive);

// persist it
Uni&lt;Void&gt; persistOperation = personRepository.persist(person);

// note that once persisted, you don't need to explicitly save your entity: all
// modifications are automatically persisted on transaction commit.

// check if it's persistent
if(personRepository.isPersistent(person)){
    // delete it
    Uni&lt;Void&gt; deleteOperation = personRepository.delete(person);
}

// getting a list of all Person entities
Uni&lt;List&lt;Person&gt;&gt; allPersons = personRepository.listAll();

// finding a specific person by ID
Uni&lt;Person&gt; personById = personRepository.findById(23L);

// finding all living persons
Uni&lt;List&lt;Person&gt;&gt; livingPersons = personRepository.list("status", Status.Alive);

// counting all persons
Uni&lt;Long&gt; countAll = personRepository.count();

// counting all living persons
Uni&lt;Long&gt; countAlive = personRepository.count("status", Status.Alive);

// delete all living persons
Uni&lt;Long&gt; deleteLivingOperation = personRepository.delete("status", Status.Alive);

// delete all persons
Uni&lt;Long&gt; deleteAllOperation = personRepository.deleteAll();

// delete by id
Uni&lt;Boolean&gt; deleteByIdOperation = personRepository.deleteById(23L);

// set the name of all living persons to 'Mortal'
Uni&lt;Integer&gt; updateOperation = personRepository.update("name = 'Mortal' where status = ?1", Status.Alive);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
其余的文档只展示了基于活动记录模式的用法，但请记住，这些用法也可以用资源库模式来执行。为了简洁起见，已省略存储库模式示例。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="高级查询"><a class="anchor" href="#高级查询"></a>高级查询</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="分页"><a class="anchor" href="#分页"></a>分页</h3>
<div class="paragraph">
<p>You should only use the <code>list</code> methods if your table contains small enough data sets. For larger data sets you can use the <code>find</code> method equivalents, which return a <code>PanacheQuery</code> on which you can do paging:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// create a query for all living persons
PanacheQuery&lt;Person&gt; livingPersons = Person.find("status", Status.Alive);

// make it use pages of 25 entries at a time
livingPersons.page(Page.ofSize(25));

// get the first page
Uni&lt;List&lt;Person&gt;&gt; firstPage = livingPersons.list();

// get the second page
Uni&lt;List&lt;Person&gt;&gt; secondPage = livingPersons.nextPage().list();

// get page 7
Uni&lt;List&lt;Person&gt;&gt; page7 = livingPersons.page(Page.of(7, 25)).list();

// get the number of pages
Uni&lt;Integer&gt; numberOfPages = livingPersons.pageCount();

// get the total number of entities returned by this query without paging
Uni&lt;Long&gt; count = livingPersons.count();

// and you can chain methods of course
Uni&lt;List&lt;Person&gt;&gt; persons = Person.find("status", Status.Alive)
        .page(Page.ofSize(25))
        .nextPage()
        .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>PanacheQuery</code> 类型有许多其他方法来处理分页和返回流。</p>
</div>
</div>
<div class="sect2">
<h3 id="使用range而不是pages"><a class="anchor" href="#使用range而不是pages"></a>使用range而不是pages</h3>
<div class="paragraph">
<p><code>PanacheQuery</code> 也允许基于范围的查询。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// create a query for all living persons
PanacheQuery&lt;Person&gt; livingPersons = Person.find("status", Status.Alive);

// make it use a range: start at index 0 until index 24 (inclusive).
livingPersons.range(0, 24);

// get the range
Uni&lt;List&lt;Person&gt;&gt; firstRange = livingPersons.list();

// to get the next range, you need to call range again
Uni&lt;List&lt;Person&gt;&gt; secondRange = livingPersons.range(25, 49).list();</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>你不能混合使用ranges和pages：如果你使用range，所有依赖于拥有当前页面的方法将抛出一个 <code>UnsupportedOperationException</code> ；你可以使用 <code>page(Page)</code> 或 <code>page(int, int)</code> 切换回分页。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="排序"><a class="anchor" href="#排序"></a>排序</h3>
<div class="paragraph">
<p>All methods accepting a query string also accept the following simplified query form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Uni&lt;List&lt;Person&gt;&gt; persons = Person.list("order by name,birth");</code></pre>
</div>
</div>
<div class="paragraph">
<p>But these methods also accept an optional <code>Sort</code> parameter, which allows your to abstract your sorting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Uni&lt;List&lt;Person&gt;&gt; persons = Person.list(Sort.by("name").and("birth"));

// and with more restrictions
Uni&lt;List&lt;Person&gt;&gt; persons = Person.list("status", Sort.by("name").and("birth"), Status.Alive);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Sort</code> 类有很多方法用于添加列和指定排序方向。</p>
</div>
</div>
<div class="sect2">
<h3 id="简化查询"><a class="anchor" href="#简化查询"></a>简化查询</h3>
<div class="paragraph">
<p>Normally, HQL queries are of this form: <code>from EntityName [where &#8230;&#8203;] [order by &#8230;&#8203;]</code>, with optional elements at the end.</p>
</div>
<div class="paragraph">
<p>If your select query does not start with <code>from</code>, we support the following additional forms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>order by &#8230;&#8203;</code> which will expand to <code>from EntityName order by &#8230;&#8203;</code></p>
</li>
<li>
<p><code>&lt;singleColumnName&gt;</code> (and single parameter) which will expand to <code>from EntityName where &lt;singleColumnName&gt; = ?</code></p>
</li>
<li>
<p><code>&lt;query&gt;</code> will expand to <code>from EntityName where &lt;query&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If your update query does not start with <code>update</code>, we support the following additional forms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>from EntityName &#8230;&#8203;</code> which will expand to <code>update from EntityName &#8230;&#8203;</code></p>
</li>
<li>
<p><code>set? &lt;singleColumnName&gt;</code> (and single parameter) which will expand to <code>update from EntityName set &lt;singleColumnName&gt; = ?</code></p>
</li>
<li>
<p><code>set? &lt;update-query&gt;</code> will expand to <code>update from EntityName set &lt;update-query&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If your delete query does not start with <code>delete</code>, we support the following additional forms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>from EntityName &#8230;&#8203;</code> which will expand to <code>delete from EntityName &#8230;&#8203;</code></p>
</li>
<li>
<p><code>&lt;singleColumnName&gt;</code> (and single parameter) which will expand to <code>delete from EntityName where &lt;singleColumnName&gt; = ?</code></p>
</li>
<li>
<p><code>&lt;query&gt;</code> will expand to <code>delete from EntityName where &lt;query&gt;</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can also write your queries in plain <a href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#hql">HQL</a>:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Order.find("select distinct o from Order o left join fetch o.lineItems");
Order.update("update from Person set name = 'Mortal' where status = ?", Status.Alive);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="named-queries"><a class="anchor" href="#named-queries"></a>Named queries</h3>
<div class="paragraph">
<p>You can reference a named query instead of a (simplified) HQL query by prefixing its name with the '#' character. You can also use named queries for count, update and delete queries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
@NamedQueries({
    @NamedQuery(name = "Person.getByName", query = "from Person where name = ?1"),
    @NamedQuery(name = "Person.countByStatus", query = "select count(*) from Person p where p.status = :status"),
    @NamedQuery(name = "Person.updateStatusById", query = "update Person p set p.status = :status where p.id = :id"),
    @NamedQuery(name = "Person.deleteById", query = "delete from Person p where p.id = ?1")
})
public class Person extends PanacheEntity {
    public String name;
    public LocalDate birth;
    public Status status;

    public static Uni&lt;Person&gt; findByName(String name){
        return find("#Person.getByName", name).firstResult();
    }

    public static Uni&lt;Long&gt; countByStatus(Status status) {
        return count("#Person.countByStatus", Parameters.with("status", status).map());
    }

    public static Uni&lt;Long&gt; updateStatusById(Status status, Long id) {
        return update("#Person.updateStatusById", Parameters.with("status", status).and("id", id));
    }

    public static Uni&lt;Long&gt; deleteById(Long id) {
        return delete("#Person.deleteById", id);
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Named queries can only be defined inside your JPA entity classes (being the Panache entity class, or the repository parameterized type), or on one of its super classes.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="查询参数"><a class="anchor" href="#查询参数"></a>查询参数</h3>
<div class="paragraph">
<p>You can pass query parameters by index (1-based) as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Person.find("name = ?1 and status = ?2", "stef", Status.Alive);</code></pre>
</div>
</div>
<div class="paragraph">
<p>或者使用 <code>Map</code> ，按名字来命名：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();
params.put("name", "stef");
params.put("status", Status.Alive);
Person.find("name = :name and status = :status", params);</code></pre>
</div>
</div>
<div class="paragraph">
<p>或者使用方便的类 <code>Parameters</code> ，既可以是原样，也可以是建立一个 <code>Map</code> 。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// generate a Map
Person.find("name = :name and status = :status",
         Parameters.with("name", "stef").and("status", Status.Alive).map());

// use it as-is
Person.find("name = :name and status = :status",
         Parameters.with("name", "stef").and("status", Status.Alive));</code></pre>
</div>
</div>
<div class="paragraph">
<p>每个查询操作都接受按索引（ <code>Object&#8230;&#8203;</code> ）或按名称（ <code>Map&lt;String,Object&gt;</code> 或 <code>Parameters</code> ）传递参数。</p>
</div>
</div>
<div class="sect2">
<h3 id="查询映射"><a class="anchor" href="#查询映射"></a>查询映射</h3>
<div class="paragraph">
<p>查询映射可以使用 <code>find()</code> 方法返回的 <code>PanacheQuery</code> 对象上的 <code>project(Class)</code> 方法来完成。</p>
</div>
<div class="paragraph">
<p>You can use it to restrict which fields will be returned by the database.</p>
</div>
<div class="paragraph">
<p>Hibernate will use <strong>DTO projection</strong> and generate a SELECT clause with the attributes from the projection class. This is also called <strong>dynamic instantiation</strong> or <strong>constructor expression</strong>, more info can be found on the Hibernate guide: <a href="https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html#hql-select-clause">hql select clause</a></p>
</div>
<div class="paragraph">
<p>The projection class needs to be a valid Java Bean and have a constructor that contains all its attributes, this constructor will be used to instantiate the projection DTO instead of using the entity class. This must be the only constructor of the class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.runtime.annotations.RegisterForReflection;

@RegisterForReflection <i class="conum" data-value="1"></i><b>(1)</b>
public class PersonName {
    public final String name; <i class="conum" data-value="2"></i><b>(2)</b>

    public PersonName(String name){ <i class="conum" data-value="3"></i><b>(3)</b>
        this.name = name;
    }
}

// only 'name' will be loaded from the database
PanacheQuery&lt;PersonName&gt; query = Person.find("status", Status.Alive).project(PersonName.class);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@RegisterForReflection</code> annotation instructs Quarkus to keep the class and its members during the native compilation. More details about the <code>@RegisterForReflection</code> annotation can be found on the <a href="writing-native-applications-tips#registerForReflection">native application tips</a> page.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use public fields here, but you can use private fields and getters/setters if you prefer.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This constructor will be used by Hibernate, and it must have a matching constructor with all the class attributes as parameters.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The implementation of the <code>project(Class)</code> method uses the constructor&#8217;s parameter names to build the select clause of the query, so the compiler must be configured to store parameter names inside the compiled class. This is enabled by default if you are using the Quarkus Maven archetype. If you are not using it, add the property <code>&lt;maven.compiler.parameters&gt;true&lt;/maven.compiler.parameters&gt;</code> to your pom.xml.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If in the DTO projection object you have a field from a referenced entity, you can use the <code>@ProjectedFieldName</code> annotation to provide the path for the SELECT statement.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Dog extends PanacheEntity {
    public String name;
    public String race;
    @ManyToOne
    public Person owner;
}

@RegisterForReflection
public class DogDto {
    public String name;
    public String ownerName;

    public DogDto(String name, @ProjectedFieldName("owner.name") String ownerName) {  <i class="conum" data-value="1"></i><b>(1)</b>
        this.name = name;
        this.ownerName = ownerName;
    }
}

PanacheQuery&lt;DogDto&gt; query = Dog.findAll().project(DogDto.class);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>ownerName</code> DTO constructor&#8217;s parameter will be loaded from the <code>owner.name</code> HQL property.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multiple-persistence-units"><a class="anchor" href="#multiple-persistence-units"></a>Multiple Persistence Units</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hibernate Reactive in Quarkus currently does not support multiple persistence units.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="事务"><a class="anchor" href="#事务"></a>事务</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure to wrap methods modifying your database (e.g. <code>entity.persist()</code>) within a transaction. Marking a CDI bean method <code>@ReactiveTransactional</code> will do that for you and make that method a transaction boundary. Alternatively, you can use <code>Panache.withTransaction()</code> for the same effect. We recommend doing so at your application entry point boundaries like your REST endpoint controllers.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You cannot use <code>@Transactional</code> with Hibernate Reactive for your transactions: you must use <code>@ReactiveTransactional</code>, and your annotated method must return a <code>Uni</code> to be non-blocking. Otherwise it needs be called from a non-<code>VertxThread</code> thread and will become blocking.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>JPA batches changes you make to your entities and sends changes (it&#8217;s called flush) at the end of the transaction or before a query. This is usually a good thing as it&#8217;s more efficient. But if you want to check optimistic locking failures, do object validation right away or generally want to get immediate feedback, you can force the flush operation by calling <code>entity.flush()</code> or even use <code>entity.persistAndFlush()</code> to make it a single method call. This will allow you to catch any <code>PersistenceException</code> that could occur when JPA send those changes to the database. Remember, this is less efficient so don&#8217;t abuse it. And your transaction still has to be committed.</p>
</div>
<div class="paragraph">
<p>Here is an example of the usage of the flush method to allow making a specific action in case of <code>PersistenceException</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ReactiveTransactional
public Uni&lt;Void&gt; create(Person person){
    //Here I use the persistAndFlush() shorthand method on a Panache repository to persist to database then flush the changes.
    return person.persistAndFlush()
            .onFailure(PersistenceException.class)
            .recoverWithItem(() -&gt; {
                LOG.error("Unable to create the parameter", pe);
                //in case of error, I save it to disk
                diskPersister.save(person);
                return null;
            });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@ReactiveTransactional</code> annotation will also work for testing. This means that changes done during the test will be propagated to the database. If you want any changes made to be rolled back at the end of the test you can use the <code>io.quarkus.test.TestReactiveTransaction</code> annotation. This will run the test method in a transaction, but roll it back once the test method is complete to revert any database changes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lock-management"><a class="anchor" href="#lock-management"></a>Lock management</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Panache provides direct support for database locking with your entity/repository, using <code>findById(Object, LockModeType)</code> or <code>find().withLock(LockModeType)</code>.</p>
</div>
<div class="paragraph">
<p>The following examples are for the active record pattern, but the same can be used with repositories.</p>
</div>
<div class="sect2">
<h3 id="first-locking-using-findbyid"><a class="anchor" href="#first-locking-using-findbyid"></a>First: Locking using findById().</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class PersonEndpoint {

    @GET
    public Uni&lt;Person&gt; findByIdForUpdate(Long id){
        return Panache.withTransaction(() -&gt; {
            return Person.&lt;Person&gt;findById(id, LockModeType.PESSIMISTIC_WRITE)
                    .invoke(person -&gt; {
                        //do something useful, the lock will be released when the transaction ends.
                    });
        });
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="second-locking-in-a-find"><a class="anchor" href="#second-locking-in-a-find"></a>Second: Locking in a find().</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class PersonEndpoint {

    @GET
    public Uni&lt;Person&gt; findByNameForUpdate(String name){
        return Panache.withTransaction(() -&gt; {
            return Person.&lt;Person&gt;find("name", name).withLock(LockModeType.PESSIMISTIC_WRITE).firstResult()
                    .invoke(person -&gt; {
                        //do something useful, the lock will be released when the transaction ends.
                    });
        });
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Be careful that locks are released when the transaction ends, so the method that invokes the lock query must be called within a transaction.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="自定义id"><a class="anchor" href="#自定义id"></a>自定义ID</h2>
<div class="sectionbody">
<div class="paragraph">
<p>IDs are often a touchy subject, and not everyone&#8217;s up for letting them handled by the framework, once again we have you covered.</p>
</div>
<div class="paragraph">
<p>You can specify your own ID strategy by extending <code>PanacheEntityBase</code> instead of <code>PanacheEntity</code>. Then you just declare whatever ID you want as a public field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person extends PanacheEntityBase {

    @Id
    @SequenceGenerator(
            name = "personSequence",
            sequenceName = "person_id_seq",
            allocationSize = 1,
            initialValue = 4)
    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "personSequence")
    public Integer id;

    //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re using repositories, then you will want to extend <code>PanacheRepositoryBase</code> instead of <code>PanacheRepository</code> and specify your ID type as an extra type parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class PersonRepository implements PanacheRepositoryBase&lt;Person,Integer&gt; {
    //...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mocking"><a class="anchor" href="#mocking"></a>Mocking</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="using-the-active-record-pattern"><a class="anchor" href="#using-the-active-record-pattern"></a>Using the active record pattern</h3>
<div class="paragraph">
<p>If you are using the active record pattern you cannot use Mockito directly as it does not support mocking static methods, but you can use the <code>quarkus-panache-mock</code> module which allows you to use Mockito to mock all provided static methods, including your own.</p>
</div>
<div class="paragraph">
<p>Add this dependency to your build file:</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-panache-mock&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">testImplementation("io.quarkus:quarkus-panache-mock")</code></pre>
</div>
</div>
<div class="paragraph">
<p>提供这个简单的实体：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person extends PanacheEntity {

    public String name;

    public static Uni&lt;List&lt;Person&gt;&gt; findOrdered() {
        return find("ORDER BY name").list();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>你可以像这样写你的模拟测试。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
public class PanacheFunctionalityTest {

    @Test
    public void testPanacheMocking() {
        PanacheMock.mock(Person.class);

        // Mocked classes always return a default value
        Assertions.assertEquals(0, Person.count().await().indefinitely());

        // Now let's specify the return value
        Mockito.when(Person.count()).thenReturn(Uni.createFrom().item(23l));
        Assertions.assertEquals(23, Person.count().await().indefinitely());

        // Now let's change the return value
        Mockito.when(Person.count()).thenReturn(Uni.createFrom().item(42l));
        Assertions.assertEquals(42, Person.count().await().indefinitely());

        // Now let's call the original method
        Mockito.when(Person.count()).thenCallRealMethod();
        Assertions.assertEquals(0, Person.count().await().indefinitely());

        // Check that we called it 4 times
        PanacheMock.verify(Person.class, Mockito.times(4)).count();<i class="conum" data-value="1"></i><b>(1)</b>

        // Mock only with specific parameters
        Person p = new Person();
        Mockito.when(Person.findById(12l)).thenReturn(Uni.createFrom().item(p));
        Assertions.assertSame(p, Person.findById(12l).await().indefinitely());
        Assertions.assertNull(Person.findById(42l).await().indefinitely());

        // Mock throwing
        Mockito.when(Person.findById(12l)).thenThrow(new WebApplicationException());
        try {
            Person.findById(12l);
            Assertions.fail();
        } catch (WebApplicationException x) {
        }

        // We can even mock your custom methods
        Mockito.when(Person.findOrdered()).thenReturn(Uni.createFrom().item(Collections.emptyList()));
        Assertions.assertTrue(Person.findOrdered().await().indefinitely().isEmpty());

        PanacheMock.verify(Person.class).findOrdered();
        PanacheMock.verify(Person.class, Mockito.atLeastOnce()).findById(Mockito.any());
        PanacheMock.verifyNoMoreInteractions(Person.class);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Be sure to call your <code>verify</code> and <code>do*</code> methods on <code>PanacheMock</code> rather than <code>Mockito</code>, otherwise you won&#8217;t know what mock object to pass.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="mocking-mutiny-session-and-entity-instance-methods"><a class="anchor" href="#mocking-mutiny-session-and-entity-instance-methods"></a>Mocking <code>Mutiny.Session</code> and entity instance methods</h4>
<div class="paragraph">
<p>If you need to mock entity instance methods, such as <code>persist()</code> you can do it by mocking the Hibernate Reactive <code>Mutiny.Session</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
public class PanacheMockingTest {

    @InjectMock
    Mutiny.Session session;

    @Test
    public void testPanacheSessionMocking() {
        Person p = new Person();
        // mocked via Mutiny.Session mocking
        p.persist().await().indefinitely();
        Assertions.assertNull(p.id);

        Mockito.verify(session, Mockito.times(1)).persist(Mockito.any());
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="使用资源库模式"><a class="anchor" href="#使用资源库模式"></a>使用资源库模式</h3>
<div class="paragraph">
<p>如果你使用存储库模式，你可以直接使用Mockito，使用 <code>quarkus-junit5-mockito</code> 模块，这使得模拟Bean变得更加容易：</p>
</div>
<div class="listingblock primary asciidoc-tabs-target-sync-cli asciidoc-tabs-target-sync-maven">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-junit5-mockito&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock secondary asciidoc-tabs-target-sync-gradle">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-gradle hljs" data-lang="gradle">testImplementation("io.quarkus:quarkus-junit5-mockito")</code></pre>
</div>
</div>
<div class="paragraph">
<p>提供这个简单的实体：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person {

    @Id
    @GeneratedValue
    public Long id;

    public String name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>还有这个储存库：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class PersonRepository implements PanacheRepository&lt;Person&gt; {
    public Uni&lt;List&lt;Person&gt;&gt; findOrdered() {
        return find("ORDER BY name").list();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>你可以像这样写你的模拟测试。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
public class PanacheFunctionalityTest {
    @InjectMock
    PersonRepository personRepository;

    @Test
    public void testPanacheRepositoryMocking() throws Throwable {
        // Mocked classes always return a default value
        Assertions.assertEquals(0, mockablePersonRepository.count().await().indefinitely());

        // Now let's specify the return value
        Mockito.when(mockablePersonRepository.count()).thenReturn(Uni.createFrom().item(23l));
        Assertions.assertEquals(23, mockablePersonRepository.count().await().indefinitely());

        // Now let's change the return value
        Mockito.when(mockablePersonRepository.count()).thenReturn(Uni.createFrom().item(42l));
        Assertions.assertEquals(42, mockablePersonRepository.count().await().indefinitely());

        // Now let's call the original method
        Mockito.when(mockablePersonRepository.count()).thenCallRealMethod();
        Assertions.assertEquals(0, mockablePersonRepository.count().await().indefinitely());

        // Check that we called it 4 times
        Mockito.verify(mockablePersonRepository, Mockito.times(4)).count();

        // Mock only with specific parameters
        Person p = new Person();
        Mockito.when(mockablePersonRepository.findById(12l)).thenReturn(Uni.createFrom().item(p));
        Assertions.assertSame(p, mockablePersonRepository.findById(12l).await().indefinitely());
        Assertions.assertNull(mockablePersonRepository.findById(42l).await().indefinitely());

        // Mock throwing
        Mockito.when(mockablePersonRepository.findById(12l)).thenThrow(new WebApplicationException());
        try {
            mockablePersonRepository.findById(12l);
            Assertions.fail();
        } catch (WebApplicationException x) {
        }

        // We can even mock your custom methods
        Mockito.when(mockablePersonRepository.findOrdered()).thenReturn(Uni.createFrom().item(Collections.emptyList()));
        Assertions.assertTrue(mockablePersonRepository.findOrdered().await().indefinitely().isEmpty());

        Mockito.verify(mockablePersonRepository).findOrdered();
        Mockito.verify(mockablePersonRepository, Mockito.atLeastOnce()).findById(Mockito.any());
        Mockito.verify(mockablePersonRepository).persist(Mockito.&lt;Person&gt; any());
        Mockito.verifyNoMoreInteractions(mockablePersonRepository);
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="how-and-why-we-simplify-hibernate-reactive-mappings"><a class="anchor" href="#how-and-why-we-simplify-hibernate-reactive-mappings"></a>How and why we simplify Hibernate Reactive mappings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When it comes to writing Hibernate Reactive entities, there are a number of annoying things that users have grown used to reluctantly deal with, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>重复ID逻辑：大多数实体需要一个ID，大多数人并不关心它是如何设置的，因为它与你的模型并不真正相关。</p>
</li>
<li>
<p>繁琐的 getters 和 setters：由于Java语言中缺乏对属性的支持，我们必须创建字段，然后为这些字段getters 和 setters，即使它们除了read/write字段外实际上没有做任何事情。</p>
</li>
<li>
<p>传统的EE模式建议将实体定义（模型）与你可以对其进行的操作（DAO、Repositories）分开，但实际上这需要在状态和其操作之间进行不自然的分割，尽管在面向对象的架构中，我们永远不会对普通对象做这样的事情，因为状态和方法是在同一个类中。此外，这需要每个实体有两个类，并且需要在你需要进行实体操作的地方注入DAO或Repository，这就破坏了你的编辑流程，需要你从正在编写的代码中跳出来，建立一个注入点，然后再回来使用它。</p>
</li>
<li>
<p>Hibernate queries are super powerful, but overly verbose for common operations, requiring you to write queries even when you don&#8217;t need all the parts.</p>
</li>
<li>
<p>Hibernate is very general-purpose, but does not make it trivial to do trivial operations that make up 90% of our model usage.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>通过Panache，我们采取了一种有主见的方法来解决所有这些问题：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make your entities extend <code>PanacheEntity</code>: it has an ID field that is auto-generated. If you require a custom ID strategy, you can extend <code>PanacheEntityBase</code> instead and handle the ID yourself.</p>
</li>
<li>
<p>使用公共字段。摆脱繁琐的getter和setters。在后台，我们将生成所有缺失的getter和setter，并重写对这些字段的每个访问，以使用访问器方法。这样，当你需要时，你仍然可以写出 <em>有用的</em> 访问器，即使你的实体用户仍然使用字段访问，也会被使用。</p>
</li>
<li>
<p>使用活动记录模式：把你所有的实体逻辑放在实体类的静态方法中，不要创建DAO。你的实体超类带有很多超级有用的静态方法，你也可以在你的实体类中添加你自己的静态方法。用户可以通过输入 <code>Person.</code> ，开始使用你的实体 <code>Person</code> ，并在一个地方获得所有操作的完成。</p>
</li>
<li>
<p>Don&#8217;t write parts of the query that you don&#8217;t need: write <code>Person.find("order by name")</code> or <code>Person.find("name = ?1 and status = ?2", "stef", Status.Alive)</code> or even better <code>Person.find("name", "stef")</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>That&#8217;s all there is to it: with Panache, Hibernate Reactive has never looked so trim and neat.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="在外部项目或jar中定义实体"><a class="anchor" href="#在外部项目或jar中定义实体"></a>在外部项目或jar中定义实体</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hibernate Reactive with Panache relies on compile-time bytecode enhancements to your entities.</p>
</div>
<div class="paragraph">
<p>It attempts to identify archives with Panache entities (and consumers of Panache entities) by the presence of the marker file <code>META-INF/panache-archive.marker</code>. Panache includes an annotation processor that will automatically create this file in archives that depend on Panache (even indirectly). If you have disabled annotation processors you may need to create this file manually in some cases.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you include the jpa-modelgen annotation processor this will exclude the Panache annotation processor by default. If you do this you should either create the marker file yourself, or add the <code>quarkus-panache-common</code> as well, as shown below:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
    &lt;version&gt;${compiler-plugin.version}&lt;/version&gt;
    &lt;configuration&gt;
      &lt;annotationProcessorPaths&gt;
        &lt;annotationProcessorPath&gt;
          &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
          &lt;artifactId&gt;hibernate-jpamodelgen&lt;/artifactId&gt;
          &lt;version&gt;${hibernate.version}&lt;/version&gt;
        &lt;/annotationProcessorPath&gt;
        &lt;annotationProcessorPath&gt;
          &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
          &lt;artifactId&gt;quarkus-panache-common&lt;/artifactId&gt;
          &lt;version&gt;${quarkus.platform.version}&lt;/version&gt;
        &lt;/annotationProcessorPath&gt;
      &lt;/annotationProcessorPaths&gt;
    &lt;/configuration&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
</div>
</div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus是开放的。这个项目的所有依赖关系在<a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a>许可或者可以在有互换性的许可下使用。<br /><br />这个网站使用 <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a> 来构建，代码托管于<a href='https://pages.github.com/' target='_blank'>Github Pages</a>，完全开源。当需要改善和丰富内容的时候，我们会从 <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>网站项目</a>创建分支，然后修正并发布到网站。</p>

    
      <div class="width-1-12 project-links">
        <span>导航栏</span>
        <ul class="footer-links">
          
            <li><a href="/">主页</a></li>
          
            <li><a href="/about">关于Quarkus</a></li>
          
            <li><a href="/blog">博客</a></li>
          
            <li><a href="/insights">播客</a></li>
          
            <li><a href="/events">活动</a></li>
          
            <li><a href="/newsletter">新闻</a></li>
          
            <li><a href="/publications">发表</a></li>
          
            <li><a href="/awards">获奖</a></li>
          
            <li><a href="/security">安全</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>社交媒体</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Twitter</a></li>
          
            <li><a href="https://www.facebook.com/quarkusio">Facebook</a></li>
          
            <li><a href="https://www.linkedin.com/company/quarkusio/">Linkedin</a></li>
          
            <li><a href="https://www.youtube.com/channel/UCaW8QG_QoIk_FnjLgr5eOqg">Youtube</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>协助</span>
        <ul class="footer-links">
          
            <li><a href="/support">支持</a></li>
          
            <li><a href="/guides">指南</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">入门</a></li>
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://github.com/quarkusio/quarkus/discussions">讨论</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">开发邮件列表</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Languages</span>
        <ul class="footer-links">
          
            <li><a href="https://quarkus.io/">English</a></li>
          
            <li><a href="https://ja.quarkus.io/">日本語</a></li>
          
            <li><a href="https://cn.quarkus.io/">简体中文</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus由社区项目组成：</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">更多...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
  <script src="/assets/javascript/clipboard.min.js" type="text/javascript"></script>
  <script src="/assets/javascript/copy.js" type="text/javascript"></script>
  <script src="/assets/javascript/asciidoc-tabs.js" type="text/javascript"></script>
</body>

</html>
